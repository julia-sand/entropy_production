from main import *
import functions
from scipy.signal import find_peaks
import matplotlib.pyplot as plt
#import plots
import matplotlib.lines as mlines
import matplotlib.gridspec as gridspec
from plots import *
#from datafetch import *

#format axes
def format_axes(ax):
  #ax.set_xscale('log')
  #ax.invert_xaxis()
  #ax.set_ylim((4.6,5.3))
  #ax.set_xlim((0.11,(8e-7)))
  ax.tick_params(axis='y', labelsize=fontsizeticks)
  ax.tick_params(axis='x', labelsize=fontsizeticks)
  #ax.set_ylabel(r"$\mathcal{E}$",fontsize = fontsizetitles)

f1 = "results_SYM.csv"
f2 = "results.csv"
f3 = "results_FLIP_TEMP.csv"

lw = 3

fig = plt.figure(figsize = (15,12))
gs1 = fig.add_gridspec(3, 2)


for peaks in enumerate([f1,f2,f3]):
  
  print(peaks[0])
  df_temp = pd.read_csv(peaks[1], sep=" ", header = 0)
  #round the t0 and t2 columns just in case it still isnt working
  df_temp = df_temp.round({'t0': dps, 't2': dps})
  times_t0_temp = df_temp.t0.unique()
  times_t0_temp.sort()

  q_axis_temp = df_temp.x.unique()
  q_axis_temp.sort()

  #function to get underdamped distribution
  def distribution_temp(t0 ):
    #t2 = round(t0*(epsilon**2),dps)
    dist = df_temp[df_temp.t0==t0].UDpdf.to_numpy()
    return dist


  #function to get underdamped distribution
  def rho_temp(t0):
    #t2 = round(t0*(epsilon**2),dps)
    dist = df_temp[df_temp.t0==t0].ptx.to_numpy()
    return dist

  height_a = np.zeros(len(times_t0_temp))
  height_b = np.zeros(len(times_t0_temp))
  ODheight_a = np.zeros(len(times_t0_temp))
  ODheight_b = np.zeros(len(times_t0_temp))

  loc_a = np.zeros(len(times_t0_temp))
  loc_b = np.zeros(len(times_t0_temp))
  ODloc_a = np.zeros(len(times_t0_temp))
  ODloc_b = np.zeros(len(times_t0_temp))

  for t in enumerate(times_t0_temp):
    series = distribution_temp(t[1])
    rho_vals = rho_temp(t[1])
    peaks,props  = find_peaks(series,prominence=(0.01, None))
    peaks_rho,props_rho  = find_peaks(rho_vals,prominence=(0.01, None))

    prominences = props['prominences']
    prominences_rho = props_rho['prominences']


    ind1 = peaks[np.argmax(prominences)]
    ind1_rho = peaks_rho[np.argmax(prominences_rho)]
    try:
      ind2 = peaks[np.argsort(prominences)[-2]]
    except:
      ind2 = ind1
    try:
      ind2_rho = peaks_rho[np.argsort(prominences_rho)[-2]]
    except:
      ind2_rho = ind1_rho


    height_a[t[0]] = series[ind1]
    height_b[t[0]] = series[ind2]
    ODheight_a[t[0]] = rho_vals[ind1_rho]
    ODheight_b[t[0]] = rho_vals[ind2_rho]
    loc_a[t[0]] = q_axis_temp[ind1]
    loc_b[t[0]] = q_axis_temp[ind2]
    ODloc_a[t[0]] = q_axis_temp[ind1_rho]
    ODloc_b[t[0]] = q_axis_temp[ind2_rho]



  fig.add_subplot(gs1[peaks[0],0])
  #plt.title("Height of peaks")

  plt.plot(times_t0_temp,height_a,lw=lw,color="royalblue",label = "Underdamped")
  plt.plot(times_t0_temp,height_b,lw=lw,color="royalblue")
  plt.plot(times_t0_temp,ODheight_a,lw=lw,color = "orange",label = "Overdamped")
  plt.plot(times_t0_temp,ODheight_b,lw=lw,color = "orange")
  #plt.ylim((0.25,0.45))

  ax = plt.gca()
  #plots.format_axes(ax,fontsizeticks)
  ax.set_ylabel("Peak Height",fontsize=fontsizetitles)
  format_axes(ax)


  fig.add_subplot(gs1[peaks[0],1])
  ax2 = plt.gca()
  #ax2.title("Location of peaks")
  ax2.scatter(times_t0_temp,loc_a,lw=lw,color="royalblue",label = "Underdamped")
  ax2.scatter(times_t0_temp,loc_b,lw=lw,color="royalblue")
  ax2.scatter(times_t0_temp,ODloc_a,lw=lw,color = "orange",label = "Overdamped")
  ax2.scatter(times_t0_temp,ODloc_b,lw=lw,color = "orange")
  format_axes(ax2)
  ax2.set_ylabel("Peak Location",fontsize=fontsizetitles)



#get legend
orange_line = mlines.Line2D([], [],color="orange",lw=lw)
blue_line = mlines.Line2D([], [],color="royalblue",lw=lw)


legend = fig1.legend(handles=[blue_line,orange_line,green_line],
          labels=["Total Entropy Production","Overdamped Bound",r"$\mathcal{W}_2$-distance"],
          fontsize = fontsizetitles,
          frameon = False,
          handlelength = 1,
          ncols = 3)
          #bbox_to_anchor=(0.75,0.2))

#move the legend
legend.set_bbox_to_anchor(bbox=(0.95,0.1))



plt.savefig("peakheights_0.png",bbox_inches="tight")
plt.close()